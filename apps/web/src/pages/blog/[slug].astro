---
import BaseLayout from '../../components/layout/BaseLayout.astro';
import Container from '../../components/ui/Container.astro';
import Badge from '../../components/ui/Badge.astro';
import { getAllPosts, getPostBySlug } from '../../lib/sanity';
import { getImageUrl } from '../../lib/image';
import { renderPortableText } from '../../lib/portable-text';
import type { Post } from '../../types';

export async function getStaticPaths() {
  const posts = await getAllPosts();
  return posts.map((post) => ({
    params: { slug: post.slug.current },
  }));
}

const { slug } = Astro.params;
const post = await getPostBySlug(slug as string);

if (!post) {
  return Astro.redirect('/blog');
}

const imageUrl = getImageUrl(post.coverImage, { width: 1200, height: 600 });
const seoTitle = post.seo?.metaTitle || post.title;
const seoDescription = post.seo?.metaDescription || post.excerpt;

const formattedDate = new Date(post.publishedAt).toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// JSON-LD for BlogPosting
const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'BlogPosting',
  headline: post.title,
  description: post.excerpt,
  author: {
    '@type': 'Person',
    name: post.author || 'Fahad Hussain',
  },
  datePublished: post.publishedAt,
  image: imageUrl,
};
---

<BaseLayout
  title={seoTitle}
  description={seoDescription}
  ogImage={imageUrl || undefined}
  type="article"
>
  <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

  <article class="py-24">
    <Container>
      <div class="max-w-3xl mx-auto">
        <!-- Back Link -->
        <a href="/blog" class="inline-flex items-center text-muted hover:text-accent transition-colors mb-8 no-underline">
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
          Back to Blog
        </a>

        <!-- Header -->
        <header class="mb-12">
          {post.categories && post.categories.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-4">
              {post.categories.map((category) => (
                <Badge variant="accent">{category}</Badge>
              ))}
            </div>
          )}
          <h1 class="text-4xl md:text-5xl font-bold text-text mb-6 leading-tight">
            {post.title}
          </h1>
          <div class="flex items-center gap-4 text-sm text-muted">
            <span>{post.author || 'Fahad Hussain'}</span>
            <span class="text-border">|</span>
            <time datetime={post.publishedAt}>{formattedDate}</time>
            {post.readingTime && (
              <>
                <span class="text-border">|</span>
                <span>{post.readingTime} min read</span>
              </>
            )}
          </div>
        </header>

        <!-- Cover Image -->
        {imageUrl && (
          <div class="aspect-video rounded-lg overflow-hidden mb-12 bg-panel">
            <img
              src={imageUrl}
              alt={post.coverImage?.alt || post.title}
              class="w-full h-full object-cover"
            />
          </div>
        )}

        <!-- Content -->
        <div class="prose prose-lg max-w-none">
          <Fragment set:html={renderPortableText(post.body)} />
        </div>

        <!-- Footer -->
        <footer class="mt-16 pt-12 border-t border-border">
          <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
            <div class="text-center sm:text-left">
              <p class="text-text font-medium">Written by {post.author || 'Fahad Hussain'}</p>
              <p class="text-muted text-sm">Lead Software Engineer specializing in fintech systems</p>
            </div>
            <a
              href="/contact"
              class="text-accent hover:underline text-sm font-medium no-underline"
            >
              Get in touch &rarr;
            </a>
          </div>
        </footer>
      </div>
    </Container>
  </article>
</BaseLayout>
