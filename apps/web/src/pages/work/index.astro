---
import BaseLayout from '../../components/layout/BaseLayout.astro';
import Container from '../../components/ui/Container.astro';
import WorkCard from '../../components/work/WorkCard.astro';
import Badge from '../../components/ui/Badge.astro';
import { getAllCaseStudies } from '../../lib/sanity';
import type { CaseStudy } from '../../types';

let caseStudies: CaseStudy[] = [];

try {
  caseStudies = await getAllCaseStudies();
} catch (error) {
  console.error('Error fetching case studies:', error);
}

// Placeholder case studies when Sanity has no content
const placeholderCaseStudies = [
  {
    title: 'Wallet & Transaction Processing System',
    problem: 'Needed a reliable way to track balances, transactions, and payment states across multiple providers.',
    outcome: 'Designed a ledger-based wallet system with idempotent webhooks and event-driven processing.',
    stack: ['Node.js', 'Django', 'MySQL', 'Redis', 'RabbitMQ'],
    slug: { current: 'wallet-transaction-system' },
    gradient: 'from-cyan-500/20 to-blue-600/20',
    icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12a2.25 2.25 0 00-2.25-2.25H15a3 3 0 11-6 0H5.25A2.25 2.25 0 003 12m18 0v6a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 18v-6m18 0V9M3 12V9m18 0a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 9m18 0V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v3" />`,
  },
  {
    title: 'Multi-Gateway Payment Integrations',
    problem: 'Payment flows were tightly coupled and hard to monitor or reconcile.',
    outcome: 'Built a unified payment layer with queue-based processing and full webhook reconciliation.',
    stack: ['Node.js', 'Python', 'BullMQ', 'RabbitMQ', 'REST APIs'],
    slug: { current: 'payment-integrations' },
    gradient: 'from-purple-500/20 to-pink-600/20',
    icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />`,
  },
  {
    title: 'CRM Re-Architecture & Performance Stabilization',
    problem: 'Legacy CRM frontend and backend were slowing development and affecting reliability.',
    outcome: 'Led a gradual re-architecture, improving performance and stabilizing releases without downtime.',
    stack: ['React', 'APIs', 'Elasticsearch', 'AWS'],
    slug: { current: 'crm-rearchitecture' },
    gradient: 'from-emerald-500/20 to-teal-600/20',
    icon: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6.429 9.75L2.25 12l4.179 2.25m0-4.5l5.571 3 5.571-3m-11.142 0L2.25 7.5 12 2.25l9.75 5.25-4.179 2.25m0 0L21.75 12l-4.179 2.25m0 0l4.179 2.25L12 21.75 2.25 16.5l4.179-2.25m11.142 0l-5.571 3-5.571-3" />`,
  },
];

const showPlaceholders = caseStudies.length === 0;
---

<BaseLayout
  title="Work"
  description="Case studies showcasing my work in fintech systems, payment platforms, and backend architecture."
>
  <section class="py-12">
    <Container>
      <div class="mb-8">
        <h1 class="text-2xl md:text-3xl font-bold text-text mb-2">Selected Work</h1>
        <p class="text-sm text-muted">Systems I've designed, built, and operated in production.</p>
      </div>

      {showPlaceholders ? (
        <div class="grid lg:grid-cols-3 gap-5">
          {placeholderCaseStudies.map((study) => (
            <div class="card-interactive overflow-hidden group">
              {/* Visual thumbnail */}
              <div class={`relative h-28 bg-gradient-to-br ${study.gradient} flex items-center justify-center overflow-hidden`}>
                {/* Grid pattern overlay */}
                <div class="absolute inset-0 opacity-10" style="background-image: linear-gradient(var(--text) 1px, transparent 1px), linear-gradient(90deg, var(--text) 1px, transparent 1px); background-size: 20px 20px;"></div>

                {/* Icon */}
                <div class="relative w-12 h-12 rounded-xl bg-panel/80 backdrop-blur border border-border flex items-center justify-center group-hover:scale-105 transition-transform">
                  <svg
                    class="w-6 h-6 text-primary"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                    set:html={study.icon}
                  />
                </div>

                {/* Decorative elements */}
                <div class="absolute top-3 left-3 w-2 h-2 rounded-full bg-primary/40"></div>
                <div class="absolute bottom-3 right-3 w-1.5 h-1.5 rounded-full bg-secondary/40"></div>
                <div class="absolute top-1/2 right-6 w-8 h-px bg-border/50"></div>
                <div class="absolute bottom-8 left-6 w-6 h-px bg-border/50"></div>
              </div>

              {/* Content */}
              <div class="p-5">
                <h3 class="text-sm font-semibold text-text mb-3">{study.title}</h3>
                <div class="space-y-2 mb-4">
                  <div>
                    <span class="text-[10px] font-medium text-muted uppercase tracking-wide">Problem</span>
                    <p class="text-xs text-text-2 mt-0.5 line-clamp-2">{study.problem}</p>
                  </div>
                  <div>
                    <span class="text-[10px] font-medium text-muted uppercase tracking-wide">Outcome</span>
                    <p class="text-xs text-text-2 mt-0.5 line-clamp-2">{study.outcome}</p>
                  </div>
                </div>
                <div class="flex flex-wrap gap-1">
                  {study.stack.slice(0, 4).map((tech) => (
                    <Badge size="sm">{tech}</Badge>
                  ))}
                </div>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-5">
          {caseStudies.map((caseStudy) => (
            <WorkCard caseStudy={caseStudy} />
          ))}
        </div>
      )}
    </Container>
  </section>
</BaseLayout>
